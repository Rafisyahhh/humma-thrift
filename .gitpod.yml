image: gitpod/workspace-full

# Commands that will run on workspace start
tasks:
  - name: Setup & Build
    before: |
      sudo apt update
      sudo apt install -y software-properties-common
      sudo add-apt-repository -y ppa:ondrej/php
      sudo apt update -y
      sudo apt install -y php8.3 php8.3-sqlite3
      touch database/database.sqlite
      sudo mkdir -p --mode=0755 /usr/share/keyrings
      curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-main.gpg >/dev/null
      echo "deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflared.list
      sudo apt-get update -y && sudo apt-get install -y cloudflared
      mkdir -p /home/gitpod/.cloudflared
      echo "url: http://localhost:8000" > /home/gitpod/.cloudflared/config.yml
      echo "tunnel: c4d8b28f-f6ca-483e-9161-29f32f7f1efa" >> /home/gitpod/.cloudflared/config.yml
      echo "credentials-file: /home/gitpod/.cloudflared/c4d8b28f-f6ca-483e-9161-29f32f7f1efa.json" >> /home/gitpod/.cloudflared/config.yml
      echo '{"AccountTag":"73157285f608392c805d6876e7ecc1ef","TunnelSecret":"DSLjdHYJvbkPxMBKsTFE321t00JeA+ZuBt2JKAg/QJU=","TunnelID":"c4d8b28f-f6ca-483e-9161-29f32f7f1efa"}' > /home/gitpod/.cloudflared/c4d8b28f-f6ca-483e-9161-29f32f7f1efa.json
      echo "-----BEGIN PRIVATE KEY-----\nMIGHAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBG0wawIBAQQgXfZfODrdrMpS0ywC\nvRZJs8H4WTLRKZlF2C+IPVUjryehRANCAATTr0qMDlGXkl04hboF1mYA7QmcFqbv\nFEhnb9HTlE0bPx/t8zROJTpdvsP9hABWT6gBSAVW+VQfBClRhUcnl8xq\n-----END PRIVATE KEY-----\n-----BEGIN CERTIFICATE-----\nMIIDKjCCAtCgAwIBAgIUcaoorheoVBcc2CoMlz2IFNENoPswCgYIKoZIzj0EAwIw\ngY8xCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1T\nYW4gRnJhbmNpc2NvMRkwFwYDVQQKExBDbG91ZEZsYXJlLCBJbmMuMTgwNgYDVQQL\nEy9DbG91ZEZsYXJlIE9yaWdpbiBTU0wgRUNDIENlcnRpZmljYXRlIEF1dGhvcml0\neTAeFw0yNDA4MDkwNjUwMDBaFw0zOTA4MDYwNjUwMDBaMGIxGTAXBgNVBAoTEENs\nb3VkRmxhcmUsIEluYy4xHTAbBgNVBAsTFENsb3VkRmxhcmUgT3JpZ2luIENBMSYw\nJAYDVQQDEx1DbG91ZEZsYXJlIE9yaWdpbiBDZXJ0aWZpY2F0ZTBZMBMGByqGSM49\nAgEGCCqGSM49AwEHA0IABNOvSowOUZeSXTiFugXWZgDtCZwWpu8USGdv0dOUTRs/\nH+3zNE4lOl2+w/2EAFZPqAFIBVb5VB8EKVGFRyeXzGqjggE0MIIBMDAOBgNVHQ8B\nAf8EBAMCBaAwHQYDVR0lBBYwFAYIKwYBBQUHAwIGCCsGAQUFBwMBMAwGA1UdEwEB\n/wQCMAAwHQYDVR0OBBYEFKRoe01m7lp0FGWQSniCaKMmuvWyMB8GA1UdIwQYMBaA\nFIUwXTsqcNTt1ZJnB/3rObQaDjinMEQGCCsGAQUFBwEBBDgwNjA0BggrBgEFBQcw\nAYYoaHR0cDovL29jc3AuY2xvdWRmbGFyZS5jb20vb3JpZ2luX2VjY19jYTAtBgNV\nHREEJjAkghEqLmh1bW1hdGhyaWZ0Lnh5eoIPaHVtbWF0aHJpZnQueHl6MDwGA1Ud\nHwQ1MDMwMaAvoC2GK2h0dHA6Ly9jcmwuY2xvdWRmbGFyZS5jb20vb3JpZ2luX2Vj\nY19jYS5jcmwwCgYIKoZIzj0EAwIDSAAwRQIhAOyx8kqrDZyjAtCBPiVUr8FnjiZb\nOPEnLHu9aFRZIssfAiB4JvlQdYs/4BrrHYAga3ZBRVO3/AKvyDIiAK2dvIcnYA==\n-----END CERTIFICATE-----\n-----BEGIN ARGO TUNNEL TOKEN-----\neyJ6b25lSUQiOiI2ZDYxMGY2ZDUxMzZlYTM2YzdiZDkxNjFiZjVlMzg2MSIsImFj\nY291bnRJRCI6IjczMTU3Mjg1ZjYwODM5MmM4MDVkNjg3NmU3ZWNjMWVmIiwic2Vy\ndmljZUtleSI6InYxLjAtNGJkYjQ2OGRmMjdmYzExMDEzMDQ4MDA3LTU4Y2RjODNj\nOTdjMzJmMDgzOTg4YzM5MWJlZDBkYTEwZjBiNGY0OWZlYTlhNjExZjUxYTdhNzcy\nNTQ2OTg4YmFlZGMxNTM2YWUzZGE5ODVhZWUwNjAwM2MyYWYwMGIyNDhkMGVlZjIx\nZTk3MWRiOTFiY2QyNjhkNDU5ODA5ZjQ5NjQ0MDVmMDQwZjFkZTY0YWMwNjU3NzY4\nMDU5Yjg4NTkiLCJhcGlUb2tlbiI6IjE0VU9kOW52OWthdjBkc0V5Y1RURmJOblZG\ndlJuUUEtNC1IdGlhNVUifQ==\n-----END ARGO TUNNEL TOKEN-----" > /home/gitpod/.cloudflared/cert.pem
      composer install
      npm i concurrently -g
      concurrently "php artisan serve" "cloudflared tunnel run hummathrift"
